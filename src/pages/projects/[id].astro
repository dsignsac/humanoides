---
import Layout from "../../layouts/Layout.astro";
import ImageWithSkeleton from "../../components/ImageWithSkeleton.astro";
import { Image } from "astro:assets";
import fs from "node:fs";
import path from "node:path";
import ProgressRing from "../../components/charts/ProgressRing.astro";

export function getProjects() {
  const projectsDir = path.resolve("./public/projects");
  const projectFolders = fs.readdirSync(projectsDir);

  return projectFolders
    .map((folder) => {
      const infoPath = path.join(projectsDir, folder, "info.json");
      if (fs.existsSync(infoPath)) {
        return JSON.parse(fs.readFileSync(infoPath, "utf-8"));
      }
      return null;
    })
    .filter(Boolean)
    .sort((a, b) => parseInt(b.year) - parseInt(a.year));
}

export function getStaticPaths() {
  const projectsData = getProjects();
  return projectsData.map((project) => ({
    params: { id: project.id },
    props: { project, projectsData },
  }));
}

const { project, projectsData } = Astro.props;

// Basic next project logic
const currentIndex = projectsData.findIndex((p) => p.id === project.id);
const nextProjectData = projectsData[(currentIndex + 1) % projectsData.length];
const nextProject = {
  slug: nextProjectData.id,
  title: nextProjectData.client,
};

// Forced Global UI Palette (Melbourne style)
const uiPalette = {
  base: "#1A1A1A",
  contraste: "#FA2A2A",
  textos: "#D4DAD3",
  logos: "#FA2A2A",
};

// Helper for image paths
const getPath = (src: string) => {
  if (!src) return "";
  if (src.startsWith("/") || src.startsWith("http")) return src;
  return `/projects/${project.id}/${src}`;
};

// Helper to check if a slide has content
const hasContent = (slide: any) => {
  if (slide.type === "hero" || slide.type === "image") return true;
  if (slide.type === "tasks" || slide.type === "process") {
    return slide.items && slide.items.length > 0;
  }
  if (slide.type === "results") {
    const hasStats = slide.stats && slide.stats.length > 0;
    const hasMetrics = slide.metrics && slide.metrics.progressRings?.show && slide.metrics.progressRings.items?.length > 0;
    return hasStats || hasMetrics;
  }
  return false;
};
---

<Layout title={`${project.client} // Humanoides`}>
  <main
    class="min-h-screen bg-[#1A1A1A] text-[#D4DAD3] pb-0 selection:bg-brand-red selection:text-white"
  >
    <!-- PROJECT THEMED AREA -->
    <div
      class="project-area w-full transition-colors duration-700 bg-[#1A1A1A]"
      style={`color: ${uiPalette.textos}; --p-contraste: ${uiPalette.contraste}; --p-textos: ${uiPalette.textos}; --p-logos: ${uiPalette.logos};`}
    >
      <!-- Desktop Layout (Hidden on Mobile) -->
      <div id="desktop-showcase-container" class="hidden md:block">
        <div class="max-w-[1440px] mx-auto px-6">
          <div class="flex flex-col md:flex-row relative">
            <!-- Left Panel: Context & Data (Sticky) -->
            <aside
              id="data-aside"
              class="w-full md:w-5/12 h-screen sticky top-0 flex flex-col justify-center z-20 bg-[#1A1A1A] overflow-hidden"
            >
              <!-- Horizontal Slide Container -->
              <div
                id="data-scroll-container"
                class="w-full h-full overflow-hidden bg-[#1A1A1A]"
              >
                <div id="slides-wrapper" class="flex h-full w-max relative">
                  {
                    project.slides?.map((slide: any) => {
                      if (!hasContent(slide)) return null;
                      return (
                      <section
                        id={slide.id}
                        class="w-[calc((min(1440px,100vw)-48px)*5/12)] h-full pl-0 pr-12 flex flex-col justify-center"
                      >
                        <div>
                          <span class="block text-sm font-bold tracking-normal mb-4 text-brand-red uppercase">
                            {slide.type === "hero" ? project.client : slide.label}
                          </span>

                          {slide.type === "hero" && (
                            <>
                              <h1 class="text-4xl md:text-5xl lg:text-7xl font-sans font-800 leading-[0.9] tracking-tighter text-(--p-textos) border-none">
                                {(project.title || slide.title)
                                  ?.split(" ")
                                  .map((word: string) => (
                                    <span class="inline-block mr-[0.2em] last:mr-0">
                                      <span class="inline-block">{word}</span>
                                    </span>
                                  ))}
                              </h1>
                              <div class="grid grid-cols-2 gap-8 py-8 border-y border-(--p-contraste)/20 mt-12">
                                <div>
                                  <h3 class="text-[10px] tracking-normal mb-2 text-(--p-contraste) uppercase">
                                    Cliente
                                  </h3>
                                  <p class="font-sans text-sm font-bold tracking-normal">
                                    {project.client}
                                  </p>
                                </div>
                                <div>
                                  <h3 class="text-[10px] tracking-normal mb-2 text-(--p-contraste) uppercase">
                                    Servicio
                                  </h3>
                                  <p class="font-sans text-sm font-bold tracking-normal">
                                    {project.service}
                                  </p>
                                </div>
                              </div>
                              <p class="text-xl font-sans font-300 leading-snug opacity-80 max-w-sm mt-8">
                                {project.description}
                              </p>
                              <div class="flex gap-2 flex-wrap max-w-sm mt-8">
                                {project.stack?.map((tech: string) => (
                                  <span class="px-3 py-1 border border-(--p-contraste)/30 text-(--p-contraste) text-[10px] tracking-normal rounded-full uppercase">
                                    {tech}
                                  </span>
                                ))}
                              </div>
                            </>
                          )}

                          {slide.type === "tasks" && (
                            <div class="space-y-6 overflow-y-auto pr-4 custom-scrollbar max-h-[70vh]">
                              {(slide.items as any[])?.map(
                                (item: any) => (
                                  <div class="p-6 border border-white/5 bg-transparent transition-colors group">
                                    <h4 class="text-xl font-bold tracking-tight mb-2 text-brand-red">
                                      {item.title}
                                    </h4>
                              <p class="text-sm leading-relaxed font-sans">
                                      {item.solution}
                                    </p>
                                    
                                    {/* Item-level Progress Ring */}
                                    {item.progressRing && (
                                      <div class="mt-4 flex justify-center">
                                        <ProgressRing 
                                          label={item.progressRing.label} 
                                          value={item.progressRing.value} 
                                          size={80} 
                                        />
                                      </div>
                                    )}
                                  </div>
                                )
                              )}
                              
                            </div>
                          )}

                          {slide.type === "results" && (
                            <div class="space-y-6">
                              <div class="p-8 border-l-2 border-brand-red bg-white/2">
                                <h3 class="text-3xl font-bold tracking-tight mb-4">{slide.title || "Resultados"}</h3>
                                <p class="text-lg opacity-80 leading-snug">{slide.description}</p>
                              </div>
                              <div class="grid grid-cols-2 gap-4">
                                {slide.stats?.map((stat: any) => (
                                  <div class="p-4 border border-white/5">
                                    <span class="block text-2xl font-bold">{stat.value}</span>
                                    <span class="text-[10px] uppercase opacity-50">{stat.label}</span>
                                  </div>
                                ))}
                              </div>

                              {/* Metrics Integration (Results - Moved from project root) */}
                              {slide.metrics && (
                                <div class="space-y-12">
                                  
                                  {slide.metrics.progressRings?.show && (
                                    <div class="grid grid-cols-3 gap-4 w-full">
                                      {slide.metrics.progressRings.items.map((item: any) => (
                                        <ProgressRing label={item.label} value={item.value} size={100} />
                                      ))}
                                    </div>
                                  )}

                                </div>
                              )}
                            </div>
                          )}

                          {slide.type === "process" && (
                            <div class="space-y-6 overflow-y-auto pr-4 custom-scrollbar max-h-[70vh]">
                                {(slide.items as any[])?.map((item: any) => (
                                  <div class="p-6 border border-white/5 bg-transparent transition-colors group">
                                    <h4 class="text-xl font-bold tracking-tight mb-2">
                                      {item.name}
                                    </h4>
                                    <p class="text-sm leading-relaxed font-sans">
                                      {item.desc}
                                    </p>
                                    
                                    {/* Item-level Progress Ring */}
                                    {item.progressRing && (
                                      <div class="mt-4 flex justify-center">
                                        <ProgressRing 
                                          label={item.progressRing.label} 
                                          value={item.progressRing.value} 
                                          size={80} 
                                        />
                                      </div>
                                    )}
                                  </div>
                                ))}
                                
                            </div>
                          )}

                          {slide.type === "image" && (
                            <div class="relative w-full aspect-square md:aspect-4/5 overflow-hidden border border-white/5">
                              <ImageWithSkeleton
                                src={getPath(slide.src)}
                                alt={slide.label}
                                className="w-full h-full"
                              />
                              {slide.caption && (
                                <div class="absolute bottom-4 left-4 bg-black/50 backdrop-blur-sm p-3 border-l-2 border-brand-red uppercase">
                                  <p class="text-[10px] tracking-normal">
                                    {slide.caption}
                                  </p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </section>
                      );
                    })
                  }
                </div>
              </div>
            </aside>

            <!-- Right Panel: Visual Gallery (Normal Scroll) -->
            <div id="gallery-right" class="w-full md:w-7/12 pt-24">
              <div class="flex flex-col">
                {
                  project.gallery?.map((item: any) => (
                    <div class="w-full group relative mb-0">
                      {item.type === "image" ? (
                        <ImageWithSkeleton
                          src={getPath(item.src)}
                          className="w-full"
                          imgClassName="h-auto block"
                          alt={item.caption || `${project.client} - ${project.title}`}
                        />
                      ) : (
                        <div class="w-full aspect-video bg-black/10 overflow-hidden">
                          <iframe
                            src={(() => {
                              const src = item.src;
                              if (src.includes("youtube.com/watch?v=")) {
                                return src.replace("watch?v=", "embed/");
                              } else if (src.includes("youtu.be/")) {
                                return src.replace("youtu.be/", "youtube.com/embed/");
                              }
                              return src;
                            })()}
                            class="w-full h-full"
                            style="width: 100%; height: 100%;"
                            allow="autoplay; fullscreen; picture-in-picture"
                            allowfullscreen
                          />
                        </div>
                      )}
                    </div>
                  ))
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Layout (Visible on Mobile) -->
      <div class="block md:hidden pt-20 bg-[#1A1A1A]">
        {
          project.slides?.map((slide: any) => {
            if (!hasContent(slide)) return null;
            return (
            <div class="flex flex-col">
              <!-- Slide Content -->
              <section class="px-6 py-16 border-b border-white/5">
                  <span class="block text-xs font-bold tracking-normal mb-6 text-brand-red uppercase">
                    {slide.type === "hero" ? project.client : slide.label}
                  </span>

                  {slide.type === "hero" && (
                    <>
                      <h1 class="text-5xl font-sans font-800 leading-[0.9] tracking-tighter text-(--p-textos) mb-8">
                        {project.title}
                      </h1>
                      <div class="grid grid-cols-2 gap-4 py-6 border-y border-(--p-contraste)/20 mb-8">
                        <div>
                          <h3 class="text-[10px] tracking-normal mb-1 text-(--p-contraste) opacity-70 uppercase">
                            Cliente
                          </h3>
                          <p class="font-sans text-xs font-bold tracking-normal">
                            {project.client}
                          </p>
                        </div>
                        <div>
                          <h3 class="text-[10px] tracking-normal mb-1 text-(--p-contraste) opacity-70 uppercase">
                            Servicio
                          </h3>
                          <p class="font-sans text-xs font-bold tracking-normal">
                            {project.service}
                          </p>
                        </div>
                      </div>
                      <p class="text-lg font-sans font-300 leading-snug opacity-80 mb-8">
                        {project.description}
                      </p>
                      <div class="flex gap-2 flex-wrap">
                        {project.stack?.map((tech: string) => (
                          <span class="px-3 py-1 border border-(--p-contraste)/30 text-(--p-contraste) text-[10px] tracking-normal rounded-full uppercase">
                            {tech}
                          </span>
                        ))}
                      </div>
                    </>
                  )}

                  {slide.type === "tasks" && (
                    <div class="space-y-4">
                      {(slide.items as any[])?.map((item: any) => (
                        <div class="p-5 border border-white/5 bg-white/2">
                          <h4 class="text-lg font-bold tracking-tight mb-2 text-brand-red">
                            {item.title}
                          </h4>
                            <p class="text-sm leading-relaxed opacity-70 font-sans">
                              {item.solution}
                            </p>
                            
                            {/* Item-level Progress Ring */}
                            {item.progressRing && (
                              <div class="mt-4 flex justify-center">
                                <ProgressRing 
                                  label={item.progressRing.label} 
                                  value={item.progressRing.value} 
                                  size={80} 
                                />
                              </div>
                            )}
                          </div>
                      ))}
                    </div>
                  )}

                  {slide.type === "results" && (
                    <div class="space-y-6">
                       <div class="p-6 border-l-2 border-brand-red bg-white/2">
                          <h3 class="text-2xl font-bold tracking-tight mb-3">{slide.title || "Resultados"}</h3>
                          <p class="text-base opacity-70 leading-snug">{slide.description}</p>
                       </div>
                       <div class="grid grid-cols-2 gap-3">
                        {slide.stats?.map((stat: any) => (
                          <div class="p-4 border border-white/5">
                            <span class="block text-xl font-bold text-white">{stat.value}</span>
                            <span class="text-[10px] uppercase opacity-50">{stat.label}</span>
                          </div>
                        ))}
                       </div>

                         {/* Mobile Metrics */}
                         {slide.metrics && (
                           <div class="mt-8 space-y-10">

                            {slide.metrics.progressRings?.show && (
                              <div class="grid grid-cols-2 gap-y-10 w-full">
                                {slide.metrics.progressRings.items.map((item: any) => (
                                  <ProgressRing label={item.label} value={item.value} size={100} />
                                ))}
                              </div>
                            )}

                         </div>
                       )}
                    </div>
                  )}

                  {slide.type === "process" && (
                    <div class="space-y-4">
                        {(slide.items as any[])?.map((item: any) => (
                          <div class="p-5 border border-white/5 bg-white/2">
                            <h4 class="text-base font-bold tracking-tight mb-2 text-brand-red">
                              {item.name}
                            </h4>
                            <p class="text-sm leading-relaxed opacity-70 font-sans">
                              {item.desc}
                            </p>
                            
                            {/* Item-level Progress Ring */}
                            {item.progressRing && (
                              <div class="mt-4 flex justify-center">
                                <ProgressRing 
                                  label={item.progressRing.label} 
                                  value={item.progressRing.value} 
                                  size={80} 
                                />
                              </div>
                            )}
                          </div>
                        ))}
                    </div>
                  )}
              </section>

              <!-- Interleaved Gallery Images -->
              {slide.mobileGalleryIndices && (
                <div class="flex flex-col">
                  {(slide.mobileGalleryIndices as number[]).map((galleryIndex) => {
                    const item = project.gallery[galleryIndex];
                    if (!item) return null;
                    return (
                      <div class="w-full relative">
                        {item.type === "image" ? (
                          <ImageWithSkeleton
                            src={getPath(item.src)}
                            className="w-full"
                            imgClassName="h-auto block"
                            alt={item.caption}
                          />
                        ) : (
                           <div class="w-full aspect-video bg-black/10 overflow-hidden">
                              <iframe
                                src={(() => {
                                  const src = item.src;
                                  if (src.includes("youtube.com/watch?v=")) {
                                    return src.replace("watch?v=", "embed/");
                                  } else if (src.includes("youtu.be/")) {
                                    return src.replace("youtu.be/", "youtube.com/embed/");
                                  }
                                  return src;
                                })()}
                                class="w-full h-full"
                                style="width: 100%; height: 100%;"
                                allow="autoplay; fullscreen; picture-in-picture"
                                allowfullscreen
                              />
                            </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            );
          })
        }
      </div>
    </div>

    <!-- FOOTER NAVIGATION (Outside project-area to keep original brand colors) -->
    <a
      href={`/projects/${nextProject.slug}`}
      class="block w-full border-t border-brand-red/20 mt-0 bg-brand-black hover:bg-brand-red transition-all duration-500 group relative overflow-hidden"
    >
      <!-- Subtle glow effect from brand guidelines section 05 -->
      <div
        class="absolute top-0 right-0 w-64 h-64 bg-brand-red blur-[100px] opacity-10 group-hover:opacity-30 transition-opacity duration-500"
      >
      </div>

      <div
        class="max-w-[1440px] mx-auto w-full px-6 md:px-6 py-16 md:py-24 flex justify-between items-center relative z-10"
      >
        <div>
          <span
            class="inline-block text-[10px] font-bold bg-brand-red/10 text-brand-red px-3 py-1 rounded-full tracking-normal mb-4 group-hover:bg-brand-black group-hover:text-white/60 transition-colors duration-500 uppercase"
          >
            Siguiente Proyecto
          </span>
          <h2
            class="text-5xl md:text-8xl font-sans font-800 tracking-tighter text-brand-red group-hover:text-brand-black transition-colors duration-500 leading-none"
          >
            {nextProject.title}
          </h2>
        </div>
        <div
          class="text-5xl md:text-8xl text-brand-red group-hover:text-brand-black group-hover:translate-x-6 transition-all duration-500"
        >
          â†’
        </div>
      </div>
    </a>

    <script>
      import { gsap } from "gsap";
      import { ScrollTrigger } from "gsap/ScrollTrigger";

      gsap.registerPlugin(ScrollTrigger);

      let ctx: any;

      const initBrutalistCase = () => {
        // Cleanup previous context and triggers
        if (ctx) ctx.revert();
        ScrollTrigger.getAll().forEach(t => t.kill());

        const scrollContainer = document.getElementById("data-scroll-container");
        const slidesWrapper = document.getElementById("slides-wrapper");
        const showcaseContainer = document.getElementById("desktop-showcase-container");
        
        if (!scrollContainer || !slidesWrapper || !showcaseContainer) return;

        ctx = gsap.context(() => {
          let mm = gsap.matchMedia();

          mm.add("(min-width: 768px)", () => {
             // Reset initial state
             gsap.set(slidesWrapper, { x: 0 });

             const sections = slidesWrapper.querySelectorAll("section");
             const steps = sections.length - 1;

             ScrollTrigger.create({
               trigger: "#desktop-showcase-container",
               start: "top top",
               end: "bottom bottom",
               scrub: true,
               invalidateOnRefresh: true,
               animation: gsap.to(slidesWrapper, {
                 x: () => -(slidesWrapper.scrollWidth - scrollContainer.offsetWidth),
                 ease: `steps(${steps})`
               })
             });
          });
        });

        // Forced refresh with multiple checks to handle layout settlement
        ScrollTrigger.refresh();
        setTimeout(() => ScrollTrigger.refresh(), 200);
        setTimeout(() => ScrollTrigger.refresh(), 1000); // Resilience for slow asset loads
      };

      // Lifecycle hooks for Astro and standard loads
      document.addEventListener("DOMContentLoaded", initBrutalistCase);
      document.addEventListener("astro:after-swap", initBrutalistCase);
      window.addEventListener("load", initBrutalistCase);
      window.addEventListener("resize", () => ScrollTrigger.refresh());
    </script>

    <style>
      /* Brutalist Scrollbar Overrides */
      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #d4dad3;
      }
      ::-webkit-scrollbar-thumb {
        background: #fa2a2a;
        border-radius: 0;
        border: 2px solid #d4dad3;
      }

      .perspective-1000 {
        perspective: 1000px;
      }
      .transform-style-3d {
        transform-style: preserve-3d;
      }
      .backface-hidden {
        backface-visibility: hidden;
      }

      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.02);
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: var(--p-contraste);
        opacity: 0.3;
      }
    </style>
  </main>
</Layout>
