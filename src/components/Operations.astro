---
import { getDataFromFolders } from "../lib/data";
import ImageWithSkeleton from "./ImageWithSkeleton.astro";

const rawTeam = getDataFromFolders("./public/team");
const team = rawTeam
  .sort((a: any, b: any) => a.order - b.order)
  .map((t: any) => ({
    ...t,
    img: `/team/${t.folder}/${t.img}`,
  }));

const agents = team.filter((m: any) => !m.isLeader);
const leader = team.find((m: any) => m.isLeader);
const allMembers = [...(leader ? [leader] : []), ...agents];

const agentLabel = (i: number) => `Asociado ${String(i + 1).padStart(2, "0")}`;
---

<!-- OPERATIONS / AGENTS SECTION -->
<section
  id="team"
  class="relative w-full bg-brand-gray text-brand-black pt-16 md:pt-28 pb-0"
>
  <!-- Section Header -->
  <div class="max-w-[1440px] mx-auto w-full px-6">
    <div class="flex flex-col mb-0">
      <div class="flex items-center gap-4 mb-4">
        <span
          class="ops-counter font-sans font-900 text-[clamp(3rem,8vw,7rem)] leading-none text-brand-black/10 select-none tabular-nums"
          aria-hidden="true">02</span
        >
        <div class="flex flex-col">
          <span class="text-[10px] font-bold tracking-[0.3em] uppercase text-brand-red font-sans"
            >Directorio Corporativo</span
          >
          <h2
            class="font-sans font-900 text-[clamp(1.4rem,3.5vw,3rem)] leading-none tracking-tight text-brand-black uppercase"
          >
            Planta Ejecutiva
          </h2>
        </div>
      </div>
      <div class="ops-divider w-full h-px bg-brand-black origin-left"></div>
    </div>
  </div>

  <!-- DESKTOP GRID: 4 equal columns -->
  <div class="hidden md:block max-w-[1440px] mx-auto w-full px-6">
    <div class="grid grid-cols-4 gap-px bg-brand-black mt-0">

      {/* ── DAVID — full color, CV button top-right ── */}
      {leader && (
        <article class="ops-card col-span-1 bg-brand-gray flex flex-col overflow-hidden" data-index={0}>
          <div class="relative w-full overflow-hidden bg-brand-black">
            <div class="ops-img-reveal absolute inset-0 bg-brand-gray z-10 origin-bottom" />
            <ImageWithSkeleton
              src={leader.img}
              alt={leader.name}
              imgClassName="w-full object-top object-center"
              widths={[400, 700]}
              sizes="(max-width: 1440px) 25vw, 360px"
            />
            {leader.cvLink && (
              <a
                href={leader.cvLink}
                download
                target="_blank"
                rel="noopener noreferrer"
                class="absolute top-0 right-0 z-20 bg-brand-red hover:bg-brand-black transition-colors duration-150 px-4 py-3 flex items-center gap-2"
                aria-label="Descargar Currículum de David"
              >
                <svg class="w-5 h-5 text-white shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="12" y1="12" x2="12" y2="18"/>
                  <polyline points="9 15 12 18 15 15"/>
                </svg>
                <span class="text-[10px] font-sans font-900 tracking-[0.2em] uppercase text-white whitespace-nowrap">Ver CV</span>
              </a>
            )}
          </div>

          <div class="flex flex-col flex-1 p-6 border-t border-brand-black">
            <div class="flex items-center gap-2 mb-3">
              <span class="ops-pulse-human block w-2 h-2 bg-brand-red shrink-0" />
              <span class="text-[10px] font-sans font-bold tracking-[0.3em] uppercase text-brand-red">Humanoide</span>
            </div>
            <h3 class="font-sans font-900 text-[clamp(1.6rem,2.2vw,2.5rem)] leading-[0.9] text-brand-black mb-2 uppercase tracking-tight">{leader.name}</h3>
            <span class="text-[10px] font-sans font-bold tracking-[0.25em] text-brand-red uppercase mb-4">{leader.role}</span>
            <div class="ops-desc-line w-full h-px bg-brand-black/30 origin-left mb-4" />
            <p class="text-sm font-sans text-brand-black font-medium leading-snug mt-auto">{leader.desc}</p>
          </div>
        </article>
      )}

      {/* ── AGENTS AI — grayscale, NO button, AI logo as faded watermark bottom-right ── */}
      {agents.map((member: any, i: number) => (
        <article class="ops-card col-span-1 bg-brand-gray flex flex-col overflow-hidden" data-index={i + 1}>
          <!-- Photo: no button, no overlay text -->
          <div class="relative w-full overflow-hidden bg-brand-black">
            <div class="ops-img-reveal absolute inset-0 bg-brand-gray z-10 origin-bottom" />
            <ImageWithSkeleton
              src={member.img}
              alt={member.name}
              imgClassName="w-full object-top grayscale"
              widths={[400, 700]}
              sizes="(max-width: 1440px) 25vw, 360px"
            />
          </div>

          <!-- Content: watermark logo + text -->
          <div class="relative flex flex-col flex-1 p-6 border-t border-brand-black overflow-hidden">
            {/* AI logo watermark — large, low opacity, cropped off bottom-right corner */}
            {member.aiLogo && (
              <div
                class="absolute bottom-0 right-0 pointer-events-none translate-x-1/4 translate-y-1/4"
                aria-hidden="true"
              >
                <img
                  src={member.aiLogo}
                  alt=""
                  class="w-32 h-32 opacity-[0.12] brightness-0"
                />
              </div>
            )}

            <div class="relative z-10 flex items-center gap-2 mb-3">
              <span class="ops-pulse block w-2 h-2 bg-brand-black shrink-0" />
              <span class="text-[10px] font-sans font-bold tracking-[0.3em] uppercase text-brand-black">{agentLabel(i)}</span>
            </div>
            <h3 class="relative z-10 font-sans font-900 text-[clamp(1.6rem,2.2vw,2.5rem)] leading-[0.9] text-brand-black mb-2 uppercase tracking-tight">{member.name}</h3>
            <span class="relative z-10 text-[10px] font-sans font-bold tracking-[0.25em] text-brand-red uppercase mb-4">{member.role}</span>
            <div class="ops-desc-line relative z-10 w-full h-px bg-brand-black/20 origin-left mb-4" />
            <p class="relative z-10 text-sm font-sans text-brand-black font-medium leading-snug mt-auto">{member.desc}</p>
          </div>
        </article>
      ))}

    </div>
  </div>

  <!-- MOBILE: Scroll-snap Carousel -->
  <div class="md:hidden w-full">
    <div class="w-full h-px bg-brand-black/20 relative overflow-hidden">
      <div
        id="ops-progress"
        class="absolute top-0 left-0 h-full bg-brand-red origin-left transition-transform duration-300"
        style="width: 100%; transform: scaleX(0);"
      ></div>
    </div>

    <div id="ops-carousel" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide">
      {allMembers.map((member: any, i: number) => {
        const agIdx = member.isLeader ? -1 : agents.findIndex((a: any) => a.ref === member.ref);
        return (
          <article class="shrink-0 w-full snap-center flex flex-col bg-brand-gray">
            <div class="relative w-full overflow-hidden bg-brand-black">
              <ImageWithSkeleton
                src={member.img}
                alt={member.name}
                imgClassName={`w-full object-top object-center ${member.isLeader ? "" : "grayscale"}`}
                widths={[400, 700]}
                sizes="100vw"
              />
              {/* CV button only for David */}
              {member.isLeader && member.cvLink && (
                <a
                  href={member.cvLink}
                  download
                  target="_blank"
                  rel="noopener noreferrer"
                  class="absolute top-0 right-0 z-10 bg-brand-red hover:bg-brand-black transition-colors px-4 py-3 flex items-center gap-2"
                  aria-label="Descargar CV"
                >
                  <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="12" x2="12" y2="18"/>
                    <polyline points="9 15 12 18 15 15"/>
                  </svg>
                  <span class="text-[10px] font-sans font-900 tracking-[0.2em] uppercase text-white">Ver CV</span>
                </a>
              )}
            </div>

            <div class="relative flex flex-col p-6 border-t border-brand-black overflow-hidden">
              {/* Watermark for agents only */}
              {!member.isLeader && member.aiLogo && (
                <div class="absolute bottom-0 right-0 pointer-events-none translate-x-1/4 translate-y-1/4" aria-hidden="true">
                  <img src={member.aiLogo} alt="" class="w-28 h-28 opacity-[0.12] brightness-0" />
                </div>
              )}

              <div class="relative z-10 flex items-center gap-2 mb-3">
                <span class={`block w-2 h-2 shrink-0 ${member.isLeader ? "bg-brand-red" : "bg-brand-black"}`} />
                <span class={`text-[10px] font-sans font-bold tracking-[0.3em] uppercase ${member.isLeader ? "text-brand-red" : "text-brand-black"}`}>
                  {member.isLeader ? "Humanoide" : agentLabel(agIdx)}
                </span>
              </div>
              <h3 class="relative z-10 font-sans font-900 text-[clamp(2rem,10vw,3rem)] leading-[0.9] text-brand-black mb-1 uppercase tracking-tight">{member.name}</h3>
              <span class="relative z-10 text-[10px] font-sans font-bold tracking-[0.25em] text-brand-red uppercase mb-4">{member.role}</span>
              <div class="relative z-10 w-full h-px bg-brand-black/20 mb-4" />
              <p class="relative z-10 text-sm font-sans text-brand-black font-medium leading-snug">{member.desc}</p>
            </div>
          </article>
        );
      })}
    </div>

    <div class="flex justify-between items-center px-6 py-4 border-t border-brand-black">
      <span id="ops-label" class="text-[10px] font-sans font-bold tracking-[0.3em] uppercase text-brand-black"></span>
      <div class="flex gap-1.5" id="ops-dots">
        {allMembers.map((_: any, i: number) => (
          <div class={`h-1 transition-all duration-300 ${i === 0 ? "bg-brand-red w-8" : "bg-brand-black/30 w-4"}`} />
        ))}
      </div>
    </div>
  </div>
</section>

<script>
  const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  const divider = document.querySelector<HTMLElement>(".ops-divider");
  if (divider) {
    if (!prefersReduced) {
      divider.style.transform = "scaleX(0)";
      divider.style.transition = "transform 0.8s cubic-bezier(0.16,1,0.3,1)";
    }
    new IntersectionObserver((entries) => {
      entries.forEach((e) => { if (e.isIntersecting) (e.target as HTMLElement).style.transform = "scaleX(1)"; });
    }, { threshold: 0.5 }).observe(divider);
  }

  document.querySelectorAll<HTMLElement>(".ops-card").forEach((card, idx) => {
    const reveal   = card.querySelector<HTMLElement>(".ops-img-reveal");
    const descLine = card.querySelector<HTMLElement>(".ops-desc-line");
    if (reveal && !prefersReduced)   reveal.style.transition   = `transform 0.9s cubic-bezier(0.16,1,0.3,1) ${idx * 0.1}s`;
    if (descLine && !prefersReduced) {
      descLine.style.transform  = "scaleX(0)";
      descLine.style.transition = `transform 0.7s cubic-bezier(0.16,1,0.3,1) ${idx * 0.1 + 0.35}s`;
    }
    new IntersectionObserver((entries) => {
      entries.forEach((e) => {
        if (e.isIntersecting) {
          if (reveal)   reveal.style.transform   = "scaleY(0)";
          if (descLine) descLine.style.transform = "scaleX(1)";
        }
      });
    }, { threshold: 0.15 }).observe(card);
  });

  if (!prefersReduced) {
    const s = document.createElement("style");
    s.textContent = `@keyframes ops-blink{0%,100%{opacity:1}50%{opacity:0.25}}.ops-pulse{animation:ops-blink 2s ease-in-out infinite}.ops-pulse-human{animation:ops-blink 1.4s ease-in-out infinite}`;
    document.head.appendChild(s);
  }

  const carousel = document.getElementById("ops-carousel");
  const dots     = document.querySelectorAll<HTMLElement>("#ops-dots div");
  const progress = document.getElementById("ops-progress") as HTMLElement | null;
  const articles = carousel?.querySelectorAll("article");

  if (carousel && articles?.length) {
    const total = articles.length;
    // Build labels for each slide from the rendered article data attrs
    const slideLabels = Array.from(articles).map((art, i) => {
      const labelEl = art.querySelector<HTMLElement>("[data-slide-label]");
      return labelEl?.dataset.slideLabel ?? (i === 0 ? "HUMANOIDE" : `ASOCIADO ${String(i).padStart(2, "0")}`);
    });
    const labelEl = document.getElementById("ops-label");
    const update = () => {
      const idx = Math.round(carousel.scrollLeft / carousel.clientWidth);
      dots.forEach((d, i) => {
        d.style.width = i === idx ? "2rem" : "1rem";
        d.classList.toggle("bg-brand-red",      i === idx);
        d.classList.toggle("bg-brand-black/30", i !== idx);
      });
      if (progress) progress.style.transform = `scaleX(${(idx + 1) / total})`;
      if (labelEl) labelEl.textContent = slideLabels[idx] ?? "";
    };
    carousel.addEventListener("scroll", update, { passive: true });
    update();
  }
</script>
