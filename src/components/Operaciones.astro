---
import fs from "node:fs";
import path from "node:path";

// Helper for dynamic data folder reading
const getDataFromFolders = (dirPath: string) => {
    const fullPath = path.resolve(dirPath);
    if (!fs.existsSync(fullPath)) return [];

    const folders = fs.readdirSync(fullPath);
    return folders
        .map((folder) => {
            const infoPath = path.join(fullPath, folder, "info.json");
            if (fs.existsSync(infoPath)) {
                try {
                    const data = JSON.parse(fs.readFileSync(infoPath, "utf-8"));
                    return { ...data, folder };
                } catch (e) {
                    console.error(`Error parsing JSON in ${infoPath}`, e);
                    return null;
                }
            }
            return null;
        })
        .filter(Boolean)
        .sort((a, b) => (a.order || 99) - (b.order || 99));
};

// Fetch Team Data
const rawTeam = getDataFromFolders("./public/team");
const team = rawTeam.map((t) => ({
    ...t,
    img: `/team/${t.folder}/${t.img}`,
}));

const agents = team;
---

<!-- TEAM SECTION (CORE) -->
<section
    id="team"
    class="relative w-full bg-brand-gray text-brand-black pt-8 md:pt-24 mb-12 md:mb-16"
>
    <div class="max-w-[1440px] mx-auto w-full px-6 relative">
        <div
            class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 md:mb-8"
        >
            <div>
                <h2
                    class="text-sm font-sans uppercase tracking-[0.2em] text-brand-red mb-2 block font-bold"
                >
                    DIRECTORIO CORPORATIVO
                </h2>
                <div class="mt-4 hidden md:block">
                    <h3
                        class="text-xl md:text-2xl font-sans font-900 text-brand-black uppercase tracking-tight mb-1"
                    >
                        Planta Ejecutiva de Operación.
                    </h3>
                    <p
                        class="text-xs md:text-sm font-sans font-medium text-brand-black"
                    >
                        Especialistas en ejecución de sistemas complejos.
                    </p>
                </div>
            </div>
            <div class="hidden md:block text-right">
                <span
                    class="text-xs font-sans tracking-widest block text-brand-black font-bold"
                    >PLANTA EJECUTIVA</span
                >
            </div>
        </div>

        <!-- TABLE HEADER (Desktop Only) -->
        <div
            class="hidden md:grid grid-cols-2 lg:grid-cols-4 gap-0 px-8 py-3 border-y border-brand-black text-xs font-sans font-bold tracking-widest uppercase text-brand-black mb-6 md:mb-12"
        >
            <div class="pl-8">Agente</div>
            <div class="pl-8">Agente</div>
            <div class="pl-8">Agente</div>
            <div class="pl-8 text-brand-red">Líder Humano</div>
        </div>

        <!-- TEAM GRID (Static Agents Only) -->
        <div class="w-full">
            <!-- Mobile Strip Visibility -->
            <div
                class="w-full border-y border-brand-black py-3 flex md:hidden justify-between items-center text-xs font-sans font-bold tracking-widest uppercase text-brand-black mb-6 px-0"
            >
                <span id="member-type-label">AI</span>
                <div class="flex gap-2" id="member-dots">
                    {
                        agents.map((_, i) => (
                            <div
                                class={`w-1.5 h-1.5 rounded-full transition-colors duration-300 ${i === 0 ? "bg-brand-red" : "bg-brand-black"}`}
                            />
                        ))
                    }
                </div>
            </div>
        </div>

        <!-- AGENTS GRID (Static) -->
        <div class="relative w-full bg-brand-gray pt-0 pb-0">
            <div
                class="flex md:hidden overflow-x-auto snap-x snap-mandatory scrollbar-hide gap-0 px-0 team-carousel mb-0"
            >
                {
                    agents.map((member) => (
                        <article
                            data-type={member.type}
                            class={`flex-shrink-0 w-full snap-center pb-2 rounded-3xl ${member.isLeader ? "bg-brand-salmon" : "bg-brand-gray"}`}
                        >
                            <div class="flex flex-col gap-4">
                                <div class="w-full aspect-[4/5] sm:aspect-video flex-shrink-0 bg-brand-gray overflow-hidden rounded-t-[1.5rem]">
                                    <img
                                        src={member.img}
                                        alt={member.name}
                                        class="w-full h-full object-cover object-top"
                                        loading="lazy"
                                        decoding="async"
                                    />
                                </div>
                                <div class="flex-grow px-6 pb-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex flex-col">
                                            <h3 class="font-sans font-900 text-5xl uppercase leading-none text-brand-black">
                                                {member.name}
                                            </h3>
                                            <span class="text-xs font-sans uppercase tracking-[0.2em] text-brand-red font-bold mt-2">
                                                {member.role}
                                            </span>
                                        </div>
                                        <span class="text-[12px] font-sans font-bold text-brand-red border border-brand-red px-2 py-1 rounded h-fit">
                                            {member.ref}
                                        </span>
                                    </div>
                                    <p class="text-lg font-sans text-brand-black font-semibold leading-tight">
                                        {member.desc}
                                    </p>
                                    {member.isLeader && (
                                        <a
                                            href="/team/david/cv.pdf"
                                            download
                                            class="mt-4 inline-flex items-center justify-center gap-3 px-8 py-4 bg-brand-red text-white text-xs md:text-sm font-900 uppercase tracking-widest rounded-full hover:bg-brand-black transition-all duration-300 group w-full md:w-fit"
                                        >
                                            <span>Ver CV</span>
                                            <svg
                                                class="w-3 h-3"
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="3"
                                            >
                                                <path d="M7 17L17 7M17 7H7M17 7V17" />
                                            </svg>
                                        </a>
                                    )}
                                </div>
                            </div>
                        </article>
                    ))
                }
            </div>

            <!-- Desktop: 2-Column (Tablet) / 4-Column (Desktop) Grid -->
            <div
                class="hidden md:grid grid-cols-2 lg:grid-cols-4 gap-px bg-brand-black"
            >
                {
                    agents.map((member) => (
                        <article
                            class={`w-full relative p-8 transition-all duration-500 overflow-hidden group/member ${member.isLeader ? "bg-brand-salmon" : "bg-brand-gray"}`}
                        >
                            <div class="flex flex-col gap-6 relative z-10">
                                <div class="w-full aspect-[3/4] flex-shrink-0 bg-brand-secondary overflow-hidden rounded-2xl relative">
                                    <img
                                        src={member.img}
                                        alt={member.name}
                                        class={`w-full h-full object-cover object-top transition-transform duration-700 ${member.isLeader ? "group-hover/member:scale-105" : ""}`}
                                        loading="lazy"
                                        decoding="async"
                                    />
                                </div>
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex flex-col">
                                            <h3 class="font-sans font-900 text-3xl xl:text-4xl capitalize leading-none text-brand-black">
                                                {member.name}
                                            </h3>
                                            <span class="text-[12px] font-sans uppercase tracking-widest text-brand-red font-bold mt-1">
                                                {member.role}
                                            </span>
                                        </div>
                                        <span
                                            class={`text-[12px] font-sans font-bold border px-2 py-1 rounded h-fit ${member.isLeader ? "text-brand-red border-brand-red" : "text-brand-black border-brand-black"}`}
                                        >
                                            {member.ref}
                                        </span>
                                    </div>
                                    <p class="text-lg md:text-xl font-sans text-brand-black font-medium leading-tight px-0">
                                        {member.desc}
                                    </p>

                                    {member.isLeader && (
                                        <a
                                            href="/team/david/cv.pdf"
                                            download
                                            class="mt-8 inline-flex items-center gap-3 px-8 py-4 bg-brand-black text-white text-xs md:text-sm font-900 uppercase tracking-widest rounded-full hover:bg-brand-red transition-all duration-300 group"
                                        >
                                            <span>Descargar CV</span>
                                            <svg
                                                class="w-3 h-3"
                                                viewBox="0 0 24 24"
                                                fill="none"
                                                stroke="currentColor"
                                                stroke-width="3"
                                            >
                                                <path d="M7 17L17 7M17 7H7M17 7V17" />
                                            </svg>
                                        </a>
                                    )}
                                </div>
                            </div>
                        </article>
                    ))
                }
            </div>
        </div>
    </div>
</section>

<script>
    // Team Carousel Logic
    const carousel = document.querySelector(".team-carousel");
    const label = document.querySelector("#member-type-label");
    const dots = document.querySelectorAll("#member-dots div");
    const articles = document.querySelectorAll(".team-carousel article");

    if (carousel instanceof HTMLElement && articles.length > 0) {
        carousel.addEventListener("scroll", () => {
            const index = Math.round(
                carousel.scrollLeft / carousel.clientWidth,
            );
            const activeArticle = articles[index];
            if (activeArticle && label) {
                label.textContent = activeArticle.getAttribute("data-type");
            }
            dots.forEach((dot, i) => {
                dot.classList.toggle("bg-brand-red", i === index);
                dot.classList.toggle("bg-brand-black", i !== index);
            });
        });
    }
</script>
