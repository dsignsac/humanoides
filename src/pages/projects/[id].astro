---
import Layout from "../../layouts/Layout.astro";
import fs from "node:fs";
import path from "node:path";

export function getProjects() {
  const projectsDir = path.resolve("./public/proyectos");
  const projectFolders = fs.readdirSync(projectsDir);

  return projectFolders
    .map((folder) => {
      const infoPath = path.join(projectsDir, folder, "info.json");
      if (fs.existsSync(infoPath)) {
        return JSON.parse(fs.readFileSync(infoPath, "utf-8"));
      }
      return null;
    })
    .filter(Boolean)
    .sort((a, b) => parseInt(b.year) - parseInt(a.year));
}

export function getStaticPaths() {
  const projectsData = getProjects();
  return projectsData.map((project) => ({
    params: { id: project.id },
    props: { project, projectsData },
  }));
}

const { project, projectsData } = Astro.props;

// Basic next project logic
const currentIndex = projectsData.findIndex((p) => p.id === project.id);
const nextProjectData = projectsData[(currentIndex + 1) % projectsData.length];
const nextProject = {
  slug: nextProjectData.id,
  title: nextProjectData.client,
};

// Brutalist Corporate Configuration
const meta = {
  id: `${project.id.toUpperCase()}-${project.year}-HA`,
  status: "OPERATIONAL",
  version: "V1.0.S",
};
---

<Layout title={`RE: ${project.client} // Humanoides`}>
  <main
    class="bg-brand-gray text-brand-black min-h-screen font-sans selection:bg-brand-red selection:text-white"
  >
    <!-- Header / Terminal Bar -->
    <header
      class="fixed top-0 left-0 w-full z-50 bg-brand-gray border-b border-brand-black/20 px-6 py-4 flex justify-between items-center backdrop-blur-sm"
    >
      <div class="flex items-center gap-4">
        <span class="w-2 h-2 bg-brand-red rounded-full animate-pulse"></span>
        <span class="text-[10px] font-mono tracking-widest uppercase opacity-60"
          >SYSTEM_STATUS: {meta.status}</span
        >
      </div>
      <div
        class="hidden md:flex gap-8 text-[10px] font-mono tracking-widest uppercase opacity-40"
      >
        <span>{meta.id}</span>
        <span>CAT_PROJECT_LOG</span>
        <span>VER_{meta.version}</span>
      </div>
    </header>

    <!-- Hero Section: Brutalist Corporate -->
    <section
      class="min-h-[80vh] pt-32 pb-20 px-6 flex flex-col justify-end border-b border-brand-black/10"
    >
      <div class="max-w-[1440px] mx-auto w-full">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-end">
          <div class="lg:col-span-8">
            <div class="mb-12">
              <span
                class="inline-block border border-brand-red text-brand-red px-3 py-1 text-[10px] font-bold tracking-[0.3em] uppercase mb-8"
              >
                ARCHIVE_FILE_{project.id.toUpperCase()}
              </span>
              <h1
                class="text-5xl md:text-[8rem] lg:text-[10rem] font-800 leading-[0.8] tracking-tighter text-brand-red uppercase break-words"
              >
                {project.client}<br />
                <span class="text-brand-black/20 italic">{project.title}</span>
              </h1>
            </div>
            <p
              class="text-xl md:text-3xl font-100 max-w-4xl leading-tight opacity-70 italic"
            >
              {
                project.description ||
                  "Inyectando eficiencia en sistemas creativos."
              }
            </p>
          </div>
          <div class="lg:col-span-4 lg:text-right">
            <div
              class="inline-block p-6 border border-brand-black/10 bg-brand-salmon text-left rounded-sm"
            >
              <span
                class="block text-[10px] font-bold uppercase tracking-widest mb-4 opacity-40"
                >INDEX_SUMMARY</span
              >
              <ul class="space-y-2 text-xs font-mono uppercase tracking-widest">
                <li
                  class="flex justify-between gap-8 border-b border-brand-black/5 pb-2"
                >
                  <span>YEAR</span>
                  <span>{project.year || "N/A"}</span>
                </li>
                <li
                  class="flex justify-between gap-8 border-b border-brand-black/5 pb-2"
                >
                  <span>SERVICE</span>
                  <span>{project.service || "N/A"}</span>
                </li>
                <li class="flex justify-between gap-8 pb-2">
                  <span>COUNTRY</span>
                  <span>{project.country || "GLOBAL"}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Technical Schematic (Animated SVG) -->
    <section
      class="architecture-section py-24 px-6 border-b border-brand-black/10 bg-brand-salmon/30 relative overflow-hidden"
    >
      <div class="max-w-[1440px] mx-auto relative z-10">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-20 items-center">
          <div>
            <h2
              class="text-xs font-bold tracking-[0.5em] text-brand-red mb-12 uppercase"
            >
              01. SCHEMATIC_OVERVIEW
            </h2>
            <h3
              class="text-3xl md:text-5xl font-800 tracking-tighter text-brand-black mb-8"
            >
              Ecosistema de Solución
            </h3>
            <p class="text-lg opacity-60 leading-relaxed max-w-lg mb-12">
              Mapeo técnico de la infraestructura implementada. Cada interacción
              representa un punto de valor sincronizado bajo los estándares
              operativos de Humanoides.
            </p>

            <div
              class="grid grid-cols-2 gap-8 border-t border-brand-black/10 pt-12"
            >
              <div>
                <span
                  class="block text-[10px] font-bold text-brand-red mb-2 uppercase tracking-widest"
                  >ID_1. CORE</span
                >
                <p
                  class="text-[10px] opacity-50 uppercase tracking-widest leading-relaxed"
                >
                  Núcleo estratégico y visual unificado.
                </p>
              </div>
              <div>
                <span
                  class="block text-[10px] font-bold text-brand-red mb-2 uppercase tracking-widest"
                  >OP_2. FLOW</span
                >
                <p
                  class="text-[10px] opacity-50 uppercase tracking-widest leading-relaxed"
                >
                  Optimización de flujos y activos.
                </p>
              </div>
            </div>
          </div>

          <div
            class="p-8 border border-brand-black/10 bg-white shadow-2xl relative group"
          >
            <svg
              viewBox="0 0 400 400"
              class="w-full h-auto text-brand-black opacity-80"
            >
              <line
                x1="0"
                y1="200"
                x2="400"
                y2="200"
                stroke="currentColor"
                stroke-width="0.5"
                stroke-dasharray="2 4"
                class="opacity-10"></line>
              <line
                x1="200"
                y1="0"
                x2="200"
                y2="400"
                stroke="currentColor"
                stroke-width="0.5"
                stroke-dasharray="2 4"
                class="opacity-10"></line>
              <rect
                x="160"
                y="160"
                width="80"
                height="80"
                fill="none"
                stroke="currentColor"
                stroke-width="2"></rect>
              <rect
                x="170"
                y="170"
                width="60"
                height="60"
                fill="currentColor"
                class="text-brand-red animate-pulse"></rect>
              <g class="module-node">
                <circle
                  cx="200"
                  cy="60"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"></circle>
              </g>
              <g class="module-node">
                <circle
                  cx="340"
                  cy="200"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"></circle>
              </g>
              <g class="module-node">
                <circle
                  cx="200"
                  cy="340"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"></circle>
              </g>
              <g class="module-node">
                <circle
                  cx="60"
                  cy="200"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"></circle>
              </g>
              <path
                d="M200 70 V160 M200 240 V330 M240 200 H330 M160 200 H70"
                fill="none"
                stroke="currentColor"
                stroke-width="1"
                stroke-dasharray="4 2"></path>
            </svg>
            <div class="absolute top-4 left-4 text-[8px] font-mono opacity-40">
              H-A_DS00
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Technical Solutions (if data exists) -->
    {
      project.challenges && (
        <section class="py-24 px-6 border-b border-brand-black/10">
          <div class="max-w-[1440px] mx-auto">
            <div class="mb-20 space-y-4">
              <h2 class="text-xs font-bold tracking-[0.5em] text-brand-red uppercase">
                02. TECHNICAL_SOLUTIONS_REPORT
              </h2>
              <h3 class="text-4xl md:text-6xl font-800 tracking-tighter">
                Sincronización de Retos
              </h3>
            </div>
            <div class="grid grid-cols-1 gap-1 border-t border-brand-black/10">
              {project.challenges.map((item: any, index: number) => (
                <div class="group border-b border-brand-black/10 py-12 flex flex-col md:grid md:grid-cols-12 gap-8 items-start hover:bg-brand-salmon/50 transition-colors duration-500 px-4 md:px-8">
                  <div class="md:col-span-1">
                    <span class="text-xs font-mono font-bold text-brand-red opacity-40">
                      T_{index + 1}
                    </span>
                  </div>
                  <div class="md:col-span-4">
                    <h4 class="text-xl md:text-3xl font-700 tracking-tighter mb-4 text-brand-red uppercase">
                      {item.title}
                    </h4>
                    <p class="text-xs border-l-2 border-brand-red pl-4 opacity-60">
                      "Challenge: {item.problem}"
                    </p>
                  </div>
                  <div class="md:col-span-5">
                    <p class="text-lg font-300 mb-6 leading-tight">
                      {item.solution}
                    </p>
                    <div class="bg-white/50 p-4 border border-brand-black/5">
                      <span class="block text-[8px] font-bold tracking-widest opacity-40 mb-2 uppercase">
                        TECHNICAL_SPEC
                      </span>
                      <p class="text-xs font-mono tracking-widest">
                        {item.technical}
                      </p>
                    </div>
                  </div>
                  <div class="md:col-span-2 text-right">
                    <div class="inline-block p-1 bg-brand-red text-white text-[8px] font-bold tracking-widest px-2">
                      RESOLVED
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>
      )
    }

    <!-- Horizontal Metrics (if data exists) -->
    {
      project.metrics && (
        <section class="metrics-horizontal-section relative h-screen bg-brand-black text-brand-gray overflow-hidden">
          <div class="sticky-container h-screen flex items-center">
            <div class="metrics-wrapper flex gap-0 px-0">
              <div class="metric-intro w-screen h-screen flex flex-col justify-center px-6 md:px-24 shrink-0 bg-brand-black">
                <div class="p-12 border border-white/10 max-w-2xl bg-white/[0.02]">
                  <h2 class="text-xs font-bold tracking-[0.5em] text-brand-red mb-12 uppercase">
                    03. AUDIT_REPORTS
                  </h2>
                  <h3 class="text-4xl md:text-8xl font-800 tracking-tighter text-white leading-[0.85] mb-8">
                    Audit Results
                  </h3>
                </div>
              </div>
              {project.metrics.map((metric: any, index: number) => (
                <div class="metric-card w-screen md:w-[50vw] h-screen flex flex-col justify-center px-12 md:px-24 shrink-0 border-r border-white/10 group hover:bg-brand-red/10 transition-colors">
                  <span class="block text-[8px] font-mono text-brand-red mb-12 opacity-60 tracking-[0.5em]">
                    LOG_0{index + 1}
                  </span>
                  <span class="block text-xs uppercase tracking-widest text-white/40 mb-4 font-bold">
                    {metric.label}
                  </span>
                  <div class="text-7xl md:text-[12rem] font-800 mb-8 tracking-tighter text-white group-hover:text-brand-red transition-colors duration-700">
                    {metric.value}
                  </div>
                  <p class="text-xl text-white/30 font-300 italic max-w-sm border-l border-white/10 pl-8">
                    {metric.desc}
                  </p>
                </div>
              ))}
            </div>
          </div>
        </section>
      )
    }

    <!-- Asset Gallery -->
    <section class="py-24 px-6 bg-brand-gray border-b border-brand-black/10">
      <div class="max-w-[1440px] mx-auto">
        <div
          class="mb-20 flex justify-between items-end border-b border-brand-black/10 pb-12"
        >
          <h2
            class="text-xs font-bold tracking-[0.5em] text-brand-red uppercase"
          >
            04. ASSET_GALLERY_PROOFS
          </h2>
        </div>

        <div
          class="grid grid-cols-1 md:grid-cols-2 gap-px bg-brand-black/10 border border-brand-black/10"
        >
          {
            project.gallery
              ? project.gallery.map((item: any, index: number) => {
                  const getPath = (src: string) => {
                    if (!src) return "";
                    if (src.startsWith("/") || src.startsWith("http"))
                      return src;
                    return `/proyectos/${project.id}/${src}`;
                  };
                  return (
                    <div class="bg-brand-gray p-8 group overflow-hidden">
                      <div
                        class={`relative overflow-hidden ${item.type === "video" ? "aspect-video" : "aspect-square"} border border-brand-black/5 shadow-inner`}
                      >
                        {item.type === "image" && (
                          <img
                            src={getPath(item.src)}
                            class="w-full h-full object-cover scale-100 group-hover:scale-105 transition-transform duration-700"
                            loading="lazy"
                          />
                        )}
                        {item.type === "video" && (
                          <iframe
                            src={item.src}
                            class="w-full h-full"
                            frameborder="0"
                            allow="autoplay; fullscreen"
                            allowfullscreen
                          />
                        )}
                        <div class="absolute top-4 right-4 bg-brand-red text-white text-[8px] px-2 py-1 font-bold">
                          SLIDE_{index + 1}
                        </div>
                      </div>
                      <div class="mt-8 flex justify-between items-start opacity-40 group-hover:opacity-100 transition-opacity">
                        <span class="text-[10px] font-mono uppercase tracking-widest">
                          {item.type}_ASSET
                        </span>
                        <span class="text-2xl font-800">/0{index + 1}</span>
                      </div>
                    </div>
                  );
                })
              : project.images?.map((img: string, index: number) => (
                  <div class="bg-brand-gray p-8 group overflow-hidden">
                    <div class="relative overflow-hidden aspect-square border border-brand-black/5 shadow-inner">
                      <img
                        src={img}
                        class="w-full h-full object-cover scale-100 group-hover:scale-105 transition-transform duration-700"
                        loading="lazy"
                      />
                      <div class="absolute top-4 right-4 bg-brand-red text-white text-[8px] px-2 py-1 font-bold">
                        SLIDE_{index + 1}
                      </div>
                    </div>
                  </div>
                ))
          }
        </div>
      </div>
    </section>

    <!-- Tech Stack Strip -->
    <section class="py-24 px-6 bg-brand-black text-brand-gray overflow-hidden">
      <div class="max-w-[1440px] mx-auto overflow-hidden">
        <div class="flex flex-wrap justify-center gap-4">
          {
            project.stack?.map((tech: string) => (
              <span class="text-[10px] font-mono uppercase tracking-[0.4em] px-6 py-2 border border-white/5 opacity-40 hover:opacity-100 hover:text-brand-red transition-all cursor-crosshair">
                [{tech}]
              </span>
            ))
          }
        </div>
      </div>
    </section>

    <!-- Footer Navigation -->
    <a
      href={`/projects/${nextProject.slug}`}
      class="block w-full bg-brand-salmon hover:bg-brand-red transition-all duration-700 group relative overflow-hidden border-t border-brand-black/10"
    >
      <div
        class="max-w-[1440px] mx-auto w-full px-6 py-32 flex flex-col md:flex-row justify-between items-center relative z-10 text-center md:text-left gap-12"
      >
        <div>
          <span
            class="block text-[10px] font-bold border border-brand-red text-brand-red px-3 py-1 uppercase tracking-widest mb-8 inline-block group-hover:border-white group-hover:text-white transition-colors"
            >INIT_NEXT_CONNECTION</span
          >
          <h2
            class="text-6xl md:text-9xl font-800 uppercase tracking-tighter group-hover:text-white transition-colors leading-[0.8] mb-4"
          >
            {nextProject.title}
          </h2>
          <p
            class="text-xs font-mono opacity-40 group-hover:text-white transition-colors"
          >
            ESTABLISHING_DATA_LINK_TO_SYSTEM_{nextProject.slug.toUpperCase()}
          </p>
        </div>
        <div
          class="text-6xl md:text-[10rem] font-100 group-hover:text-white transition-transform duration-700 group-hover:translate-x-12"
        >
          →
        </div>
      </div>
    </a>
  </main>
</Layout>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const initProjectLore = () => {
    // Hero Reveal
    gsap.from("h1", { opacity: 0, y: 50, duration: 1, ease: "power4.out" });

    // Schematic
    gsap.from(".module-node", {
      scale: 0,
      opacity: 0,
      duration: 1,
      stagger: 0.2,
      ease: "back.out(1.7)",
      scrollTrigger: {
        trigger: ".architecture-section",
        start: "top 70%",
      },
    });

    // Horizontal metrics (if element exists)
    const wrapper = document.querySelector(".metrics-wrapper");
    if (wrapper) {
      gsap.to(wrapper, {
        x: () => -(wrapper.scrollWidth - window.innerWidth),
        ease: "none",
        scrollTrigger: {
          trigger: ".metrics-horizontal-section",
          start: "top top",
          end: () => `+=${wrapper.scrollWidth}`,
          scrub: 1,
          pin: true,
          anticipatePin: 1,
        },
      });
    }
  };

  document.addEventListener("DOMContentLoaded", initProjectLore);
  document.addEventListener("astro:after-swap", initProjectLore);
</script>

<style>
  ::-webkit-scrollbar {
    width: 10px;
  }
  ::-webkit-scrollbar-track {
    background: #d4dad3;
  }
  ::-webkit-scrollbar-thumb {
    background: #fa2a2a;
    border: 2px solid #d4dad3;
  }
</style>
