---
/**
 * Portfolio Section Component
 * Stuctured for future Headless WP integration.
 * Style: Technical, Industrial, Efficient.
 */

interface Project {
  id: string;
  client: string;
  project: string;
  service: string;
  year: string;
  country: string;
  image: string; // URL for now, later WP Media Item
  srcset: string;
  url: string;
}

import fs from "node:fs";
import path from "node:path";

const projectsDir = path.resolve("./public/proyectos");
const projectFolders = fs.readdirSync(projectsDir);

const projectsData = projectFolders
  .map(folder => {
    const infoPath = path.join(projectsDir, folder, "info.json");
    if (fs.existsSync(infoPath)) {
      return JSON.parse(fs.readFileSync(infoPath, "utf-8"));
    }
    return null;
  })
  .filter(Boolean)
  .sort((a, b) => parseInt(a.projectNumber) - parseInt(b.projectNumber));

// Map scanned data to Project interface
const projects = projectsData.map(p => {
  const getImagePath = (src: string) => {
    if (!src) return "";
    if (src.startsWith("/") || src.startsWith("http")) return src;
    return `/proyectos/${p.id}/${src}`;
  };

  const getSrcSet = (imagePath: string) => {
    if (!imagePath) return "";
    const ext = imagePath.substring(imagePath.lastIndexOf('.'));
    const base = imagePath.substring(0, imagePath.lastIndexOf('.'));
    
    return `${base}-small.webp 400w, ${base}-medium.webp 800w, ${base}-large.webp 1200w, ${imagePath} 2000w`;
  };

  const imagePath = getImagePath(p.thumbnail || (p.gallery && p.gallery[0]?.src) || (p.images && p.images[0]));

  return {
    id: p.projectNumber,
    client: p.client,
    project: p.title,
    service: p.service,
    year: p.year,
    country: p.country || "GLOBAL",
    image: imagePath,
    srcset: getSrcSet(imagePath),
    url: `/projects/${p.id}`
  };
});
---

<section id="log" class="w-full bg-brand-gray text-brand-black pb-0">
  
  <div class="w-full max-w-[1440px] mx-auto px-6 pt-24">
    <!-- Big Headline -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8">
        <div>
            <h2 class="text-sm font-sans uppercase tracking-[0.2em] text-brand-red mb-2 block font-bold">Project Archive</h2>
        </div>
        <div class="hidden md:block text-right">
           <span class="text-xs font-sans tracking-widest block text-brand-black font-bold">STATUS: OPERATIONAL</span>
           <span class="text-xs font-sans tracking-widest block text-brand-black font-bold">METRIC: EFFICIENT</span>
        </div>
    </div>
  </div>

  <!-- Projects Grid / List -->
  <div class="w-full max-w-[1440px] mx-auto flex flex-col gap-12 md:gap-0">
    
    <!-- Table Header (Desktop Only) -->
    <div class="hidden md:grid grid-cols-12 gap-4 px-6 pb-4 pt-4 border-y border-brand-black text-xs font-sans font-900 tracking-widest uppercase text-brand-black">
      <div class="col-span-1">AÑO</div>
      <div class="col-span-2">LOCALIZACIÓN</div>
      <div class="col-span-4">CLIENTE / PROYECTO</div>
      <div class="col-span-3">SERVICIO</div>
      <div class="col-span-2 text-right">ACCIÓN</div>
    </div>

    <!-- Project Rows -->
    {projects.map((project) => (
      <article 
        class="article-row group relative border-b border-brand-black/10 transition-[background-color] duration-300 hover:bg-brand-salmon overflow-hidden" 
        style="will-change: background-color; transform: translateZ(0);"
      >
        <!-- Background Image Container -->
        <div 
          class="absolute top-0 right-0 h-full w-full md:w-[60%] opacity-20 md:opacity-0 md:group-hover:opacity-40 transition-opacity duration-500 pointer-events-none z-0"
          style="will-change: opacity; transform: translateZ(0); mix-blend-mode: multiply; -webkit-mask-image: linear-gradient(to right, transparent 0%, black 30%, black 100%); mask-image: linear-gradient(to right, transparent 0%, black 30%, black 100%);"
        >
            <img 
                src={project.image}
                srcset={project.srcset}
                sizes="(max-width: 768px) 100vw, 60vw"
                alt="" 
                class="w-full h-full object-cover grayscale"
                loading="lazy"
                decoding="async"
                style="backface-visibility: hidden; transform: translateZ(0);"
            />
        </div>

        <!-- Link Wrapper -->
        <a href={project.url} class="block w-full h-full relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 px-6 py-8 md:py-12 items-center">
            
            <!-- YEAR -->
            <div class="col-span-1 font-sans text-xs text-brand-red font-900 mb-2 md:mb-0">
                {project.year}
            </div>

            <!-- COUNTRY (Replacing ID) -->
            <div class="hidden md:block col-span-2 font-sans text-xs text-brand-black font-bold uppercase tracking-wider">
                {project.country}
            </div>

            <!-- Client & Project -->
            <div class="col-span-11 md:col-span-4 mb-4 md:mb-0">
                <h3 class="text-2xl md:text-3xl font-sans font-bold leading-none capitalize text-brand-black group-hover:text-brand-red transition-colors duration-300" style="will-change: color;">
                {project.client}
                </h3>
                <p class="text-sm font-sans font-semibold text-brand-black mt-1 capitalize tracking-wide">
                {project.project}
                </p>
            </div>

            <!-- Service (Desktop) -->
            <div class="hidden md:block col-span-3 font-sans text-xs uppercase tracking-wider text-brand-black font-bold group-hover:opacity-0 transition-opacity duration-300" style="will-change: opacity;">
                {project.service}
            </div>

            <!-- Mobile: Combined Meta -->
            <div class="md:hidden col-span-11 flex flex-wrap gap-4 text-xs font-sans uppercase text-brand-black font-bold mt-2">
                <span>{project.service}</span>
                <span class="text-brand-red">|</span>
                <span>{project.country}</span>
            </div>

            <!-- Arrow (Desktop) -->
            <div class="hidden md:flex col-span-2 justify-end">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-brand-black group-hover:text-brand-gray transition-colors duration-300" style="will-change: color;">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12 5 19 12 12 19"></polyline>
                 </svg>
            </div>

            </div>
        </a>
      </article>
    ))}
  </div>
