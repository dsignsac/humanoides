---
/**
 * Portfolio Section Component
 * Stuctured for future Headless WP integration.
 * Style: Technical, Industrial, Efficient.
 */

interface Project {
  id: string;
  client: string;
  project: string;
  service: string;
  year: string;
  country: string;
  image: string; // URL for now, later WP Media Item
  srcset: string;
  url: string;
}

import fs from "node:fs";
import path from "node:path";

const projectsDir = path.resolve("./public/proyectos");
const projectFolders = fs.readdirSync(projectsDir);

const projectsData = projectFolders
  .map(folder => {
    const infoPath = path.join(projectsDir, folder, "info.json");
    if (fs.existsSync(infoPath)) {
      return JSON.parse(fs.readFileSync(infoPath, "utf-8"));
    }
    return null;
  })
  .filter(Boolean)
  .sort((a, b) => parseInt(b.year) - parseInt(a.year));

// Map scanned data to Project interface and filter by landing visibility
const projects = projectsData
  .filter(p => p.showOnLanding !== false) // Default is true, only hide if explicitly false
  .map(p => {
  const getImagePath = (src: string) => {
    if (!src) return "";
    if (src.startsWith("/") || src.startsWith("http")) return src;
    return `/proyectos/${p.id}/${src}`;
  };

  const getSrcSet = (imagePath: string) => {
    if (!imagePath) return "";
    const ext = imagePath.substring(imagePath.lastIndexOf('.'));
    const base = imagePath.substring(0, imagePath.lastIndexOf('.'));
    
    return `${base}-small.webp 400w, ${base}-medium.webp 800w, ${base}-large.webp 1200w, ${imagePath} 2000w`;
  };

  const imagePath = getImagePath(p.thumbnail || (p.gallery && p.gallery[0]?.src) || (p.images && p.images[0]));

  return {
    id: p.id,
    client: p.client,
    project: p.title,
    service: p.service,
    year: p.year,
    country: p.country || "GLOBAL",
    image: imagePath,
    srcset: getSrcSet(imagePath),
    url: `/projects/${p.id}`
  };
});
---

<section id="log" class="w-full bg-brand-gray text-brand-black mb-12 md:mb-16">
  
  <div class="w-full max-w-[1440px] mx-auto px-6 pt-16 md:pt-24">
    <!-- Big Headline -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 md:mb-8">
        <div>
            <h2 class="text-sm font-sans uppercase tracking-[0.2em] text-brand-red mb-2 block font-bold">CARTERA DE PROYECTOS</h2>
            <div class="mt-4 hidden md:block">
                <h3 class="text-xl md:text-2xl font-sans font-900 text-brand-black uppercase tracking-tight mb-1">
                    Selección de operaciones recientes.
                </h3>
                <p class="text-[10px] font-sans font-bold text-brand-black/40 uppercase tracking-widest">
                    Proyectos ejecutados bajo esquema de operación directa.
                </p>
            </div>
        </div>
        <div class="hidden md:block text-right">
           <span class="text-xs font-sans tracking-widest block text-brand-black font-bold">DIVISIÓN EN PRODUCCIÓN</span>
        </div>
    </div>
  </div>

  <!-- Projects Grid / List -->
  <div class="w-full max-w-[1440px] mx-auto flex flex-col">
    
    <!-- Table Header (Desktop Only) -->
    <div class="hidden md:grid grid-cols-12 gap-4 px-6 pb-4 pt-4 border-y border-brand-black text-xs font-sans font-900 tracking-widest uppercase text-brand-black">
      <div class="col-span-1">AÑO</div>
      <div class="col-span-2">LOCALIZACIÓN</div>
      <div class="col-span-6">CLIENTE / PROYECTO</div>
      <div class="col-span-3">SERVICIO</div>
    </div>

    <!-- Project Rows -->
    <!-- Mobile Carousel -->
    <div class="flex md:hidden overflow-x-auto snap-x snap-mandatory scrollbar-hide gap-0 px-0 -mx-6 pb-4">
        {projects.map((project, index) => (
             <article class="flex-shrink-0 w-[85vw] snap-center relative flex flex-col pl-6">
                <!-- Project Image & Overlay Link -->
                <a href={project.url} class="block group relative w-full aspect-[4/3] overflow-hidden rounded-2xl mb-4 bg-gray-200">
                     <img
                        src={project.image}
                        alt={project.client}
                        class="object-cover w-full h-full transition-transform duration-700 group-hover:scale-105"
                        loading="lazy"
                      />
                      <div class="absolute top-3 left-3 bg-brand-black text-white text-[10px] font-mono uppercase tracking-widest px-2 py-1 rounded">
                         {project.year.slice(2)}
                      </div>
                </a>

                <!-- Content -->
                <div class="flex flex-col gap-1 pr-4">
                    <h3 class="text-3xl font-sans font-900 uppercase tracking-tighter leading-[0.9] text-brand-black">
                       {project.client}
                    </h3>
                    <p class="text-lg font-sans font-normal leading-tight text-brand-black/90 lowercase first-letter:uppercase">
                        {project.project}
                    </p>
                </div>

                 <div class="mt-3 flex flex-wrap gap-2">
                    <span class="inline-block px-3 py-1 bg-brand-black/5 rounded-full text-[10px] uppercase tracking-widest font-bold text-brand-black/60">
                        {project.service}
                    </span>
                 </div>
             </article>
        ))}
        <!-- Spacer for last item padding -->
        <div class="flex-shrink-0 w-6"></div>
    </div>

    <!-- Desktop List (Hidden on Mobile) -->
    <div class="hidden md:block">
        <!-- Desktop Header -->
        <div class="flex items-center justify-between border-b border-brand-black/20 pb-4 mb-4 px-6 -mx-6 text-xs font-mono opacity-50 uppercase tracking-widest">
            <div class="w-1/12">Index</div>
            <div class="w-4/12">Cliente / Proyecto</div>
            <div class="w-1/12">Año</div>
            <div class="w-2/12">País</div>
            <div class="w-2/12">Servicios</div>
            <div class="w-1/12 text-right">Link</div>
        </div>

        {projects.map((project, index) => (
          <a href={project.url} class="group relative block w-full border-b border-brand-black/10 py-12 transition-colors duration-300 hover:bg-brand-black/5 rounded-2xl px-6 -mx-6">
              <div class="flex items-center justify-between">
                  <!-- Index -->
                  <div class="w-1/12 text-xs font-mono opacity-50">
                      {String(index + 1).padStart(2, '0')}
                  </div>
                  
                  <!-- Client / Project -->
                  <div class="w-4/12">
                      <h3 class="text-6xl font-sans font-900 uppercase tracking-tighter text-brand-black group-hover:translate-x-4 transition-transform duration-500 will-change-transform">
                          {project.client}
                      </h3>
                      <p class="text-xl font-sans font-normal text-brand-black/90 mt-1 lowercase first-letter:uppercase">
                          {project.project}
                      </p>
                  </div>

                  <!-- Year -->
                  <div class="w-1/12 font-mono text-xs uppercase tracking-widest opacity-60">
                      '{project.year.slice(2)}
                  </div>

                  <!-- Country -->
                  <div class="w-2/12 font-mono text-xs uppercase tracking-widest opacity-60">
                      {project.country}
                  </div>

                   <!-- Service -->
                   <div class="w-2/12 font-mono text-xs uppercase tracking-widest opacity-60">
                      {project.service}
                   </div>

                   <!-- Arrow -->
                   <div class="w-1/12 flex justify-end">
                        <div class="w-10 h-10 rounded-full border border-brand-black/20 flex items-center justify-center group-hover:bg-brand-black group-hover:text-white transition-all duration-300">
                            <svg class="w-4 h-4 transform -rotate-45" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7" />
                            </svg>
                        </div>
                   </div>
              </div>
          </a>
        ))}
    </div>
        </a>
      </article>
    ))}
  </div>
