---
/**
 * Pricing Section Component
 * Aesthetic: 80s Corporate, Brutalist, Institutional.
 * Redesigned for Premium Card Experience with Dynamic Toggle.
 */

import pricingData from "../data/pricing.json";

const programs = pricingData.programs;
const mobilePrograms = [...programs].sort(
    (a, b) => (b.recommended ? 1 : 0) - (a.recommended ? 1 : 0),
);
---

<section
    id="tarifas"
    class="relative w-full bg-brand-gray text-brand-black pt-0 md:pt-24 mb-12 md:mb-16 overflow-hidden"
>
    <div class="max-w-[1440px] mx-auto px-6 relative z-10">
        <!-- Section Header -->
        <div
            class="flex flex-col md:flex-row justify-between items-start md:items-end pb-0 md:pb-8"
        >
            <div class="reveal-fade-up">
                <h2
                    class="text-sm font-sans uppercase tracking-[0.2em] text-brand-red mb-2 block font-bold"
                >
                    TARIFARIO CORPORATIVO
                </h2>
                <div class="mt-4 hidden md:block">
                    <h3
                        class="text-xl md:text-2xl font-sans font-900 text-brand-black uppercase tracking-tight mb-1"
                    >
                        Disponibilidad sujeta a agenda de producción.
                    </h3>
                    <p
                        class="text-[10px] font-sans font-bold text-brand-black/40 uppercase tracking-widest leading-relaxed"
                    >
                        Los programas se habilitan únicamente tras evaluación
                        operativa.
                    </p>
                </div>
            </div>
        </div>

        <!-- Institutional Header Strip -->
        <div
            class="hidden md:flex w-full border-y border-brand-black py-4 justify-between items-center text-[10px] font-sans font-900 tracking-[0.2em] uppercase text-brand-black mb-16 reveal-fade-up"
            style="animation-delay: 0.2s;"
        >
            <span>SISTEMA DE VALORIZACIÓN V2.0</span>
            <span class="hidden md:inline">TABLA DE INVERSIÓN CORPORATIVA</span>
            <span class="opacity-60">DPTO. DE OPERACIONES</span>
        </div>

        <!-- Mobile Carousel Navigation Strip -->
        <div
            class="w-full border-y border-brand-black py-3 flex md:hidden justify-between items-center text-[10px] font-sans font-bold tracking-[0.2em] uppercase text-brand-black mb-4 px-0 reveal-fade-up"
            style="animation-delay: 0.3s;"
        >
            <span>PROGRAMAS DISPONIBLES</span>
            <div class="flex gap-2" id="pricing-dots">
                {
                    mobilePrograms.map((_, i) => (
                        <div
                            class={`w-1.5 h-1.5 rounded-full transition-colors duration-300 ${i === 0 ? "bg-brand-red" : "bg-brand-black/20"}`}
                        />
                    ))
                }
            </div>
        </div>

        <div
            class="flex md:hidden overflow-x-auto snap-x snap-mandatory scrollbar-hide gap-0 px-6 pricing-carousel mb-10 md:mb-16"
        >
            {
                mobilePrograms.map((item, idx) => (
                    <article
                        data-program-id={item.id}
                        class={`flex-shrink-0 w-[calc(100vw-48px)] snap-center relative flex flex-col bg-brand-salmon p-6 transition-all duration-500 group active:scale-[0.98] rounded-3xl ${item.recommended ? "border-brand-red/20" : "border-brand-black/5"}`}
                    >
                        {item.recommended && (
                            <div class="absolute top-4 right-6 bg-brand-red text-white text-[9px] font-sans font-900 px-4 py-1.5 uppercase tracking-widest rounded-full z-10">
                                Recomendado
                            </div>
                        )}

                        <div class="mt-8 mb-4">
                            <h4 class="text-xs font-sans font-900 text-brand-red uppercase tracking-[0.2em] mb-4">
                                — {item.name}
                            </h4>

                            <!-- Level Selector -->
                            <div class="flex bg-brand-black/5 rounded-xl p-1 mb-8 level-selector" data-program={item.id}>
                                {["Basic", "Medium", "Pro"].map((level, lIdx) => (
                                    <button
                                        data-level={level}
                                        data-index={lIdx}
                                        class={`flex-1 py-3 text-[12px] font-sans font-900 uppercase tracking-widest rounded-lg transition-all duration-300 ${level === "Medium" ? "bg-brand-gray text-brand-black" : "text-brand-black/60 hover:text-brand-black/80"}`}
                                    >
                                        {level}
                                    </button>
                                ))}
                            </div>
                            
                            <div class="price-container mb-2">
                                <div class="price-monthly block">
                                    <span class="text-5xl font-sans font-999 text-brand-black lowercase tracking-tighter price-value">
                                        {item.levels.Medium.price}
                                    </span>
                                    <span class="text-[11px] font-sans font-900 text-brand-black/50 uppercase tracking-[0.2em] ml-2 price-period">
                                        {item.levels.Medium.billing_period}
                                    </span>
                                </div>
                            </div>
                            <div class="text-[10px] font-sans font-bold text-brand-black/40 uppercase tracking-widest mb-6">
                                IVA INCLUIDO (DÉBITO AUTOMÁTICO)
                            </div>

                            <p class="text-lg font-sans font-medium text-brand-black/90 leading-tight mb-8 description-text h-24 overflow-hidden">
                                {item.levels.Medium.description}
                            </p>
                        </div>

                        <div class="mt-auto">
                            <a
                                href={`/#sync?subject=${encodeURIComponent(`${item.name} - Medium`)}`}
                                class={`cta-button inline-flex items-center justify-center gap-3 w-full py-5 rounded-full text-[11px] font-sans font-900 uppercase tracking-[0.2em] transition-all duration-300 ${item.recommended ? "bg-brand-red text-white hover:bg-brand-black" : "bg-brand-black text-white hover:bg-brand-red"}`}
                            >
                                Comenzar ahora
                                <svg
                                    class="w-3.5 h-3.5"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="4"
                                >
                                    <path d="M7 17L17 7M17 7H7M17 7V17" />
                                </svg>
                            </a>
                        </div>
                    </article>
                ))
            }
        </div>

        <div class="hidden md:grid grid-cols-3 gap-6 mb-16">
            {
                programs.map((item, idx) => (
                    <article
                        class={`pricing-card reveal-fade-up relative flex flex-col bg-brand-salmon p-10 border transition-all duration-500 group md:hover:-translate-y-2.5 rounded-3xl ${item.recommended ? "border-brand-red ring-1 ring-brand-red/20" : "border-brand-black/5 md:hover:border-brand-black/20"}`}
                        style={`animation-delay: ${0.4 + idx * 0.1}s;`}
                    >
                        {item.recommended && (
                            <div class="absolute -top-3 left-10 bg-brand-red text-white text-[9px] font-sans font-900 px-4 py-1.5 uppercase tracking-widest rounded-full">
                                Recomendado para Operaciones
                            </div>
                        )}

                        <div class="mb-8">
                            <h4 class="text-sm font-sans font-900 text-brand-red uppercase tracking-[0.2em] mb-4">
                                — {item.name}
                            </h4>
                            <p class="text-lg md:text-xl font-sans font-medium text-brand-black leading-tight opacity-90">
                                {item.levels.Medium.description}
                            </p>
                        </div>

                        <div class="mt-auto pt-6 md:pt-8 border-t border-brand-black/10">
                            <div class="flex flex-col mb-6 md:mb-8 overflow-hidden h-20 justify-center">
                                <div class="price-container">
                                    <div class="price-monthly block">
                                        <span class="text-5xl font-sans font-900 text-brand-black lowercase tracking-tighter">
                                            {item.levels.Medium.price}
                                        </span>
                                        <span class="text-[10px] font-sans font-bold text-brand-black/40 uppercase tracking-widest ml-1">
                                            {item.levels.Medium.billing_period} (IVA INCL.)
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <a
                                href={`/#sync?subject=${encodeURIComponent(`${item.name} - Medium`)}`}
                                class={`inline-flex items-center justify-center gap-3 w-full py-5 rounded-full text-xs font-sans font-900 uppercase tracking-widest transition-all duration-300 after:absolute after:inset-0 z-20 ${item.recommended ? "bg-brand-red text-white hover:bg-brand-black" : "bg-brand-black text-white hover:bg-brand-red"}`}
                            >
                                Comenzar ahora
                                <svg
                                    class="w-3.5 h-3.5"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="4"
                                >
                                    <path d="M7 17L17 7M17 7H7M17 7V17" />
                                </svg>
                            </a>
                        </div>
                    </article>
                ))
            }
        </div>
    </div>
</section>

<style>
    .reveal-fade-up {
        opacity: 0;
        transform: translateY(30px);
        transition:
            opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1),
            transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        will-change: opacity, transform;
    }

    .reveal-fade-up.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .pricing-card {
        will-change: transform, box-shadow, border-color;
    }

    /* Toggle Animations */
    #toggle-monthly.active,
    #toggle-annual.active {
        background: #000;
        color: #fff;
    }

    .price-container {
        display: flex;
        flex-direction: column;
    }

    .price-monthly,
    .price-annual {
        transition:
            opacity 0.4s ease,
            transform 0.4s ease;
    }
</style>

<script>
    // Entrance Animation Logic
    const observerOptions = {
        root: null,
        rootMargin: "0px",
        threshold: 0.1,
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                (entry.target as HTMLElement).classList.add("visible");
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    document.querySelectorAll(".reveal-fade-up").forEach((el) => {
        observer.observe(el);
    });

    // Carousel Dots Logic
    const carousel = document.querySelector(".pricing-carousel");
    const dots = document.querySelectorAll("#pricing-dots div");
    const cards = document.querySelectorAll(".pricing-carousel article");

    if (carousel instanceof HTMLElement && cards.length > 0) {
        carousel.addEventListener("scroll", () => {
            const index = Math.round(
                carousel.scrollLeft / carousel.clientWidth,
            );
            dots.forEach((dot, i) => {
                dot.classList.toggle("bg-brand-red", i === index);
                dot.classList.toggle("bg-brand-black/20", i !== index);
            });
        });
    }

    // Level Switcher Logic
    import pricingData from "../data/pricing.json";
    const pricingDataRef = pricingData;

    document.querySelectorAll(".level-selector").forEach((selector) => {
        const programId = selector.getAttribute("data-program");
        const article = selector.closest("article");
        const priceValue = article?.querySelector(
            ".price-value",
        ) as HTMLElement;
        const pricePeriod = article?.querySelector(
            ".price-period",
        ) as HTMLElement;
        const descriptionText = article?.querySelector(
            ".description-text",
        ) as HTMLElement;
        const ctaButton = article?.querySelector(
            ".cta-button",
        ) as HTMLAnchorElement;
        const buttons = selector.querySelectorAll("button");

        const programData = pricingDataRef.programs.find(
            (p: any) => p.id === programId,
        );

        buttons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const level = btn.getAttribute("data-level") as string;
                // Update UI state
                buttons.forEach((b) => {
                    b.classList.remove("bg-brand-gray", "text-brand-black");
                    b.classList.add("text-brand-black/60");
                });
                btn.classList.add("bg-brand-gray", "text-brand-black");
                btn.classList.remove("text-brand-black/60");

                // Update content with fade effect
                if (priceValue && descriptionText && programData && pricePeriod) {
                    const levelData = (programData.levels as any)[level];

                    priceValue.style.opacity = "0";
                    pricePeriod.style.opacity = "0";
                    descriptionText.style.opacity = "0";

                    setTimeout(() => {
                        priceValue.innerText = levelData.price;
                        pricePeriod.innerText = levelData.billing_period;
                        descriptionText.innerText = levelData.description;
                        priceValue.style.opacity = "1";
                        pricePeriod.style.opacity = "1";
                        descriptionText.style.opacity = "1";

                        // Update CTA link
                        if (ctaButton) {
                            ctaButton.href = `/#sync?subject=${encodeURIComponent(`${programData.name} - ${level}`)}`;
                        }
                    }, 200);
                }
            });
        });
    });
</script>
